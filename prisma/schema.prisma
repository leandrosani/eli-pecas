generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id            String                  @id @default(uuid())
  email         String                  @unique
  name          String?
  avatarUrl     String?
  provider      String                  @default("email")
  createdAt     DateTime                @default(now())
  despesas      Despesa[]
  movimentacoes HistoricoMovimentacao[]
}

model AuthCode {
  id        String   @id @default(uuid())
  email     String
  code      String
  expiresAt DateTime
  createdAt DateTime @default(now())
}

model Sala {
  id          Int          @id @default(autoincrement())
  nome        String
  prateleiras Prateleira[]
}

model Prateleira {
  id     Int     @id @default(autoincrement())
  nome   String
  salaId Int
  sala   Sala    @relation(fields: [salaId], references: [id])
  caixas Caixa[]
}

model Caixa {
  id           Int        @id @default(autoincrement())
  nome         String
  prateleiraId Int
  prateleira   Prateleira @relation(fields: [prateleiraId], references: [id])
  pecas        Peca[]
}

model Peca {
  id            String                  @id @default(uuid())
  nome          String
  marca         String
  modelo        String?
  lado          String
  ano           String?
  estado        String
  detalhes      String?
  descricao     String?                 @db.Text
  Link          String?                 @db.Text
  preco         Decimal                 @db.Decimal(10, 2)
  
  // ✅ NOVO CAMPO: Custo da peça (para cálculo de margem)
  custo         Decimal                 @default(0) @db.Decimal(10, 2)
  
  quantidade    Int                     @default(1)
  fotoUrl       String?
  ativo         Boolean                 @default(true)
  caixaId       Int?
  createdAt     DateTime                @default(now())
  updatedAt     DateTime                @updatedAt
  localizacao   String?
  fotosExtras   String[]                @default([])
  movimentacoes HistoricoMovimentacao[]
  caixa         Caixa?                  @relation(fields: [caixaId], references: [id])
}

model HistoricoMovimentacao {
  id         String   @id @default(uuid())
  tipo       String   // 'ENTRADA' ou 'SAIDA'
  quantidade Int
  observacao String?
  pecaId     String
  userId     String?
  createdAt  DateTime @default(now())
  
  // ✅ NOVO CAMPO: Custo no momento da venda (Snapshot)
  custo      Decimal? @db.Decimal(10, 2)

  peca       Peca     @relation(fields: [pecaId], references: [id])
  user       User?    @relation(fields: [userId], references: [id])
}

model Despesa {
  id             String   @id @default(uuid())
  descricao      String
  categoria      String
  valor          Decimal  @db.Decimal(10, 2)
  formaPagamento String
  data           DateTime
  observacao     String?
  userId         String?
  createdAt      DateTime @default(now())
  user           User?    @relation(fields: [userId], references: [id])
}